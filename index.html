<!DOCTYPE html>
<html style="padding: 0 50px">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Електронний журнал</title>
    <link
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <h2>Список користувачів</h2>
    <form name="userForm">
      <input type="hidden" name="id" value="0" />
      <div class="form-group"> 
        <label for="name">Імя:</label>
        <input class="form-control" name="name" />
      </div>
      <div class="form-group">
        <label for="age">Вік:</label>
        <input class="form-control" name="age" />
      </div>
      <div class="form-group">
        <label for="group">Група:</label>
        <input class="form-control" name="group" />
      </div>
      <div class="form-group">
        <label for="subject">Предмет:</label>
        <select class="form-control" name="subject">
          <option value="ТП">ТП</option>
          <option value="Вишмат">Вишмат</option>
          <option value="Фізика">Фізика</option>
        </select>
      </div>
      <div class="form-group">
        <label for="teacher">Викладач:</label>
        <select class="form-control" name="teacher">
          <option value="Васильченко І.П.">Зоря І. С.</option>
          <option value="Петренко О.М.">Михалевич В. М.</option>
          <option value="Сидоренко Н.В.">Книш Б.П</option>
        </select>
      </div>
      <div class="form-group">
        <label for="workType">Вид роботи:</label>
        <select class="form-control" name="workType">
          <option value="Лабораторна робота">Лабораторна робота</option>
          <option value="Курсова робота">Курсова робота</option>
          <option value="Дипломна робота">Дипломна робота</option>
        </select>
      </div>
      <div class="form-group">
        <label for="markTime">Дата виставлення оцінки:</label>
        <input class="form-control" name="markTime" type="date" />
      </div>
      <div class="form-group">
        <label for="mark">Оцінка:</label>
        <input class="form-control" name="mark" type="number" min="1" max="5" />
      </div>
      <div class="panel-body">
        <button type="submit" class="btn btn-sm btn-primary">Зберегти</button>
        <a id="reset" class="btn btn-sm btn-primary">Очистити</a>
      </div>
    </form>
    <table class="table table-condensed table-striped table-bordered">
      <thead>
        <tr>
          <th>Id</th>
          <th>Імя</th>
          <th>Вік</th>
          <!-- Внесення змін -->
          <th>Група</th>
          <th>Предмет</th>
          <th>Викладач</th>
          <th>Вид роботи</th>
          <th>Дата виставлення оцінки</th>
          <th>Оцінка</th>
          <!-- Кінець змін в html -->
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <script>
      // Список користувачів
      async function getUsers() {
        // Відправляємо запит і отримуємо відповідь
        const response = await fetch("/api/users", {
          method: "GET",
          headers: { Accept: "application/json" },
        });
        // Якщо запит пройшов нормально
        if (response.ok === true) {
          // Отримуємо дані
          const users = await response.json();
          let rows = document.querySelector("tbody");
          users.forEach((user) => {
            // Додаємо отримані дані в таблицю
            rows.append(row(user));
          });
        }
      }
      // Отримання одного користувача
      async function getUser(id) {
        const response = await fetch("/api/users/" + id, {
          method: "GET",
          headers: { Accept: "application/json" },
        });
        if (response.ok === true) {
          const user = await response.json();
          const form = document.forms["userForm"];
          form.elements["id"].value = user.id;
          form.elements["name"].value = user.name;
          form.elements["age"].value = user.age;
          form.elements["group"].value = user.group;
          form.elements["subject"].value = user.subject;
          form.elements["teacher"].value = user.teacher;
          form.elements["workType"].value = user.workType;
          form.elements["markTime"].value = user.markTime;
          form.elements["mark"].value = user.mark;
        }
      }
      // Додавання користувача
      async function createUser(
        userName,
        userAge,
        userGroup,
        userSubject,
        userTeacher,
        userWorkType,
        usermarkTime,
        userMark
      ) {
        const response = await fetch("api/users", {
          method: "POST",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            name: userName,
            age: parseInt(userAge, 10),
            group: userGroup,
            subject: userSubject,
            teacher: userTeacher,
            workType: userWorkType,
            markTime: usermarkTime,
            mark: parseInt(userMark, 10),
          }),
        });
        if (response.ok === true) {
          const user = await response.json();
          reset();
          document.querySelector("tbody").append(row(user));
        }
      }
      // Зміна даних користувача
      async function editUser(
        userId,
        userName,
        userAge,
        userGroup,
        userSubject,
        userTeacher,
        userWorkType,
        usermarkTime,
        userMark
      ) {
        const response = await fetch("api/users", {
          method: "PUT",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            id: userId,
            name: userName,
            age: parseInt(userAge, 10),
            group: userGroup,
            subject: userSubject,
            teacher: userTeacher,
            workType: userWorkType,
            markTime: usermarkTime,
            mark: userMark,
          }),
        });
        if (response.ok === true) {
          const user = await response.json();
          reset();
          document
            .querySelector("tr[data-rowid='" + user.id + "']")
            .replaceWith(row(user));
        }
      }
      // Видалення користувача
      async function deleteUser(id) {
        const response = await fetch("/api/users/" + id, {
          method: "DELETE",
          headers: { Accept: "application/json" },
        });
        if (response.ok === true) {
          const user = await response.json();
          document.querySelector("tr[data-rowid='" + user.id + "']").remove();
        }
      }

      // Скидання форми
      function reset() {
        const form = document.forms["userForm"];
        form.reset();
        form.elements["id"].value = 0;
      }
      // Створення стрічки в таблиці
      function row(user) {
        const tr = document.createElement("tr");
        tr.setAttribute("data-rowid", user.id);

        const idTd = document.createElement("td");
        idTd.append(user.id);
        tr.append(idTd);

        const nameTd = document.createElement("td");
        nameTd.append(user.name);
        tr.append(nameTd);

        const ageTd = document.createElement("td");
        ageTd.append(user.age);
        tr.append(ageTd);

        // Внесення змін в js
        const groupTd = document.createElement("td");
        groupTd.append(user.group);
        tr.append(groupTd);

        const subjectTd = document.createElement("td");
        subjectTd.append(user.subject);
        tr.append(subjectTd);

        const teacherTd = document.createElement("td");
        teacherTd.append(user.teacher);
        tr.append(teacherTd);

        const workTypeTd = document.createElement("td");
        workTypeTd.append(user.workType);
        tr.append(workTypeTd);

        const markTimeTd = document.createElement("td");
        markTimeTd.append(user.markTime);
        tr.append(markTimeTd);

        const markTd = document.createElement("td");
        markTd.append(user.mark);
        tr.append(markTd);

        const linksTd = document.createElement("td");

        const editLink = document.createElement("a");
        editLink.setAttribute("data-id", user.id);
        editLink.setAttribute("style", "cursor:pointer;padding:15px;");
        editLink.append("Змінити");
        editLink.addEventListener("click", (e) => {
          e.preventDefault();
          getUser(user.id);
        });
        linksTd.append(editLink);

        const removeLink = document.createElement("a");
        removeLink.setAttribute("data-id", user.id);
        removeLink.setAttribute("style", "cursor:pointer;padding:15px;");
        removeLink.append("Видалити");
        removeLink.addEventListener("click", (e) => {
          e.preventDefault();
          deleteUser(user.id);
        });

        linksTd.append(removeLink);
        tr.appendChild(linksTd);

        return tr;
      }
      // Скидання значень форми
      document.getElementById("reset").addEventListener("click", (e) => {
        e.preventDefault();
        reset();
      });

      // Відправка форми
      document.forms["userForm"].addEventListener("submit", async (e) => {
        e.preventDefault();
        const form = document.forms["userForm"];
        const id = form.elements["id"].value;
        const name = form.elements["name"].value;
        const age = form.elements["age"].value;
        const group = form.elements["group"].value;
        const subject = form.elements["subject"].value;
        const teacher = form.elements["teacher"].selectedOptions[0].value;
        const workType = form.elements["workType"].selectedOptions[0].value;
        const markTime = form.elements["markTime"].value;
        const mark = form.elements["mark"].value;
        if (id == 0)
          createUser(
            name,
            age,
            group,
            subject,
            teacher,
            workType,
            markTime,
            mark
          );
        else
          editUser(
            id,
            name,
            age,
            group,
            subject,
            teacher,
            workType,
            markTime,
            mark
          );
      });

      // Завантаження користувачів
      getUsers();
    </script>
  </body>
</html>
